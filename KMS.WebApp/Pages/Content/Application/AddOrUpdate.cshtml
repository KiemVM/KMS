@page "/Application/AddOrUpdate"
@using KMS.Core.Entities.Content
@model AddOrUpdateModel
@{
    ViewBag.Title = Model.Title;
    ViewBag.ActiveMenu = ConstPathUrl.Application;
}
<div class="toolbar d-flex flex-stack flex-wrap ms-5 mb-5 mb-lg-5" id="kt_toolbar">
    <div class="page-title d-flex flex-column py-1">
        <h1 class="d-flex align-items-center my-1">
            <span class="text-dark fw-bolder fs-1">@ViewBag.Title</span>
        </h1>
    </div>
</div>
<div class="row mb-3">
<div class="col-lg-12 mb-2">
    <div class="row mb-3">
        <div class="col-lg-9">
            <div class="row">
                <div class="col-lg-6 mb-3">
                    <partial name=@InputForm.TextBox model="@(Model.InputFormViewModels.FirstOrDefault(x => x.Id == nameof(ApplicationViewModel.Name)))" />
                </div>
                <div class="col-lg-6 mb-3">
                    <partial name=@InputForm.TextArea model="@(Model.InputFormViewModels.FirstOrDefault(x => x.Id == nameof(ApplicationViewModel.Description)))" />
                </div>
            </div>
            <div class="col-lg-3 mb-3">
                <div class="form-group row">
                    <div class="col-lg-12 form-control form-control-floating card">
                        <select placeholder="none" class="form-input form-select" data-control="select2" id="CompanyId" data-placeholder="Chọn" data-minimum-results-for-search="Infinity">
                            <option value=""></option>
                        </select>
                        <label class="form-label" for="CompanyId">Công ty<span class="text-danger">*</span></label>
                    </div>
                </div>
            </div>
            <div class="col-lg-3 mb-3">
                <div class="form-group row">
                    <div class="col-lg-12 form-control form-control-floating card">
                        <select placeholder="none" class="form-input form-select" data-control="select2" id="KeyId" data-placeholder="Chọn" data-minimum-results-for-search="Infinity">
                            <option value=""></option>
                        </select>
                            <label class="form-label" for="KeyId">Key<span class="text-danger">*</span></label>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-3">
            <div class="row">
                <label>Ảnh</label>
            </div>
            <div class="row">
                <div class="col-lg-12" style="margin: auto; text-align: center;">
                    <div class="symbol symbol-100px symbol-circle mb-7">
                        <div class="avatar-upload">
                            <div class="avatar-edit">
                                <input type='file' id="imageUpload" accept=".png, .jpg, .jpeg" />
                                <label for="imageUpload">
                                    <i class="las la-edit fs-1" style="margin-left: 7px; margin-top: 4px;"></i>
                                </label>
                            </div>
                            <div class="avatar-preview">
                                    <div id="imagePreview" style="background-image: url('@(Model.ApplicationViewModel?.Image)');">
                                </div>
                            </div>
                                <input type="hidden" id="Image" value="@(Model.ApplicationViewModel?.Image)" />

                        </div>
                    </div>
                </div>
            </div>
        </div>
        </div>
    </div>
    <div style="text-align:right">
        <div>
            <button type="reset" class="btn btn-light me-3 w-120px" data-bs-dismiss="modal" onclick="back()">Quay lại</button>
            <button type="button" class="btn btn-lg btn btn-primary btn-uni w-120px me-3" onclick="Save()">
                Lưu
                <span class="indicator-progress" id="LoadProgress">
                    <span class="spinner-border spinner-border-sm align-middle ms-2"></span>
                </span>
            </button>
        </div>
    </div>
</div>
<script type="text/javascript">
    $(function() {
        @{
            var firstSchemaId = (Model.ApplicationViewModel.Keys != null && Model.ApplicationViewModel.Keys.Any())
                ? Model.ApplicationViewModel.Keys.First().Id
                : Guid.Empty;
        }
        LoadComboboxTreeApiForName("#CompanyId", "/Api/Company/SelectTreeByType", true , '@Html.Raw(Model?.ApplicationViewModel.CompanyId)', window.objAjax, "Công ty");
        LoadComboboxTreeApiForName("#KeyId", "/Api/Key/SelectTreeByType", true , '@Html.Raw(firstSchemaId)', window.objAjax, "Key");
    });



    $("#imageUpload").change(function () {
        if (this.files && this.files[0]) {
            var reader = new FileReader();
            reader.onload = function (e) {
                $('#imagePreview').css('background-image', 'url(' + e.target.result + ')');
                $('#imagePreview').hide();
                $('#imagePreview').fadeIn(650);
            }
            reader.readAsDataURL(this.files[0]);
            var formData = new FormData();
            formData.append("files", this.files[0]);
            window.objAjax.parameters = formData;
            AjaxFile("@(ConstUrl.WebCrm)/api/file/upload-files?path=@(ConstSystem.ProjectName)/Employee/AddOrUpdate&extensions=jpg,jpeg,png,bmp,gif&maxsize=10240", window.objAjax,
                function (response) {
                    debugger
                    $('#imagePreview').css('background-image', 'url(' + response[0].Url + ')');
                    $('#Image').val(response[0].Url);
                });
        }
    });


    function Save() {
        // Nếu chỉ chọn một schema từ dropdown
        var keyId = $('#KeyId').val() || '@Guid.Empty';
        var keyIds = [];
        if (keyId && keyId !== '@Guid.Empty') {
            keyIds.push(keyId);
        }

        objAjax.parameters = {
            Id: "@Model.Id",
            Name: $('#@nameof(ApplicationViewModel.Name)').val(),
            Description: $('#@nameof(ApplicationViewModel.Description)').val(),
            Image: $('#Image').val(),
            CompanyId: $('#CompanyId').val(),
            KeyIds: keyIds // truyền mảng
        };
        objAjax.divLoading = ".show>>>.modal-body";
        AjaxAsync("@Model.UrlAjax", window.objAjax,
            function (data) {
                window.location.href="@ConstPathUrl.Application";
            });
    }

    function back() {
        window.location.href="@ConstPathUrl.Application";
    }

</script>